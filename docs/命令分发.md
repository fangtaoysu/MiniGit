### **总体思路**
- 分层职责：在 Presentation 完成“编译同款”四步（词法→语法→语义→分发），仅输出干净的命令 DTO；在 Application 用命令处理器编排业务流程；Domain 暂不介入，待后续用例实现时提供复杂能力；Infrastructure 提供日志等适配。
- 依赖方向：Presentation 只依赖 Application 的抽象接口（命令总线/处理器注册表），Application 依赖 Domain 的抽象服务，所有层对 Infrastructure 仅通过接口交互。

### **数据与接口**
- Token：`type`（identifier/flag_short/flag_long/value/quoted）、`lexeme`、`position`。
- AST：`CommandNode`（`name`、`args[]`、`flags[]`），`FlagNode`（`name`、`value?`）。
- DTO（Application 输入）：`InitCommand`、`AddCommand`、`CommitCommand` 等，仅包含语义检查后的有效参数。
- Application 抽象：
  - `ICommandHandler<TCommand>`：`handle(TCommand)`。
  - `ICommandBus`/`IHandlerRegistry`：`register('init', handlerFactory)`、`dispatch(dto)`。
- Presentation 抽象：
  - `IScanner`、`IParser`、`ISemanticAnalyzer`、`IDispatcher`。

### **处理管线**
- 词法分析（Scanner）
  - 规则：空白分隔；支持引号包裹参数；短旗 `-m`、长旗 `--message`；值与等号绑定 `--msg=foo`；转义（如 `\"`）。
  - 产出：`Token[]`，保留位置信息用于错误提示。
- 语法分析（Parser）
  - 文法：`command := 'git' subcommand args flags`；`args := arg*`；`flags := flag*`；支持 `-m "msg"` 与 `--message="msg"` 两种。
  - 产出：`CommandNode`，结构化分离 `args` 与 `flags`。
- 语义分析（Analyzer）
  - 校验：子命令是否存在；必需选项是否提供（如 `commit` 的消息或编辑器策略）；参数类型与组合是否合法；引用名/路径的词法约束。
  - 符号表：可维护“已知子命令/已知选项”表，用于快速校验与错误消息建议。
  - 产出：对应的 Application 命令 DTO（如 `CommitCommand{message, amend, all, pathSpecs}`）。
- 分发执行（Dispatcher）
  - 映射：按 `CommandNode.name` 查找 `ICommandHandler`；将 Analyzer 产出的 DTO 交给命令总线/处理器执行。
  - 统一错误：将语法/语义错误转成用户可读信息，不掺杂业务执行错误。

### **扩展策略**
- 新命令支持：仅在符号表与处理器注册表增加条目；Presentation 不需要了解具体业务实现细节。
- 选项策略：保持“短旗/长旗/带值”统一解析；语义层掌握每个子命令允许的选项和默认值。

### **错误与日志**
- 错误分级：词法/语法/语义错误归 Presentation；业务冲突（如合并冲突）归 Application/Domain。
- 日志：Presentation 输出用户可读错误；将调试日志通过 Infrastructure 的 Logger 接口记录。

### **TDD 先行测试**
- Scanner 单测：空白、引号、短/长旗、等号值、转义、非法字符。
- Parser 单测：基础文法正确构树；错误分支给出期望提示。
- Analyzer 单测：已知命令/选项校验；必需/互斥选项；类型与默认值。
- Dispatcher 单测：命令名到处理器的映射；DTO 传递完整性；未知命令错误。
- E2E（最小）：输入行 → 输出预期（如 `git commit -m "msg"` 被路由到 `CommitHandler`，且收到正确 DTO）。

### **落地步骤**    
- 定义接口与 DTO（Presentation + Application 的抽象），不引入具体 Domain 依赖。
- 实现 Scanner 和 Parser（最小覆盖）并编写对应单测。
- 实现 SemanticAnalyzer：用静态命令/选项表驱动校验与 DTO 构造。
- 实现 Dispatcher + HandlerRegistry：以“命令名→处理器”映射，处理器可用 stub，便于通过测试。
- CLI 入口：读取一行命令文本，走全管线到 Dispatcher，打印结果或错误信息。

### **示例命令集（首批）**
- `init`：`args=[]`、`flags=[]`。
- `add`：`args=[pathSpec...]`、`flags=[--all]`。
- `commit`：`flags=[-m/--message, --amend, --all]`、`args=[]`。
- `status`：`flags=[--short]`、`args=[]`。
- 后续逐步扩展 `branch/tag/merge/remote/fetch/pull/push`。
