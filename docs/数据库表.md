-- =============================================
-- Git对象存储核心表
-- =============================================

```sql
-- Git对象表 - 存储所有Git对象（blob、tree、commit、tag）
CREATE TABLE git_objects (
    -- 对象标识：40字符的SHA1哈希值
    sha1 CHAR(40) PRIMARY KEY COMMENT '对象的SHA1哈希值，40字符',
    
    -- 对象类型：blob、tree、commit、tag
    object_type ENUM('blob', 'tree', 'commit', 'tag') NOT NULL COMMENT '对象类型',
    
    -- 对象原始数据（压缩存储）
    object_data LONGBLOB NOT NULL COMMENT '对象的原始数据（可能压缩）',
    
    -- 对象大小（字节）
    object_size INT UNSIGNED NOT NULL COMMENT '对象数据的大小（字节）',
    
    -- 对象内容（解压后的数据，用于快速查询）
    content_data LONGBLOB COMMENT '解压后的对象内容，用于快速访问',
    
    -- 创建时间
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '对象创建时间',
    
    -- 索引
    INDEX idx_object_type (object_type) COMMENT '按对象类型查询索引',
    INDEX idx_created_at (created_at) COMMENT '按创建时间查询索引',
    INDEX idx_object_size (object_size) COMMENT '按对象大小查询索引'
) COMMENT = 'Git对象存储表，存储所有Git对象';
```
-- =============================================
-- 引用系统表
-- =============================================

-- 引用表 - 存储所有引用（分支、标签、HEAD等）
CREATE TABLE references (
    -- 引用名称
    ref_name VARCHAR(512) PRIMARY KEY COMMENT '引用名称，如refs/heads/main, refs/tags/v1.0, HEAD',
    
    -- 引用目标：指向的commit SHA1或另一个引用
    target_sha1 CHAR(40) NOT NULL COMMENT '指向的目标SHA1（通常是commit）',
    
    -- 引用类型
    ref_type ENUM('branch', 'tag', 'head', 'remote', 'other') NOT NULL COMMENT '引用类型',
    
    -- 引用全名（规范化名称）
    full_name VARCHAR(512) NOT NULL COMMENT '引用全名，如refs/heads/main',
    
    -- 简短名称（用于显示）
    short_name VARCHAR(255) COMMENT '简短名称，如main, v1.0',
    
    -- 创建时间
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '引用创建时间',
    
    -- 最后更新时间
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '引用最后更新时间',
    
    -- 索引
    INDEX idx_ref_type (ref_type) COMMENT '按引用类型查询索引',
    INDEX idx_target_sha1 (target_sha1) COMMENT '按目标SHA1查询索引',
    INDEX idx_short_name (short_name) COMMENT '按简短名称查询索引',
    INDEX idx_updated_at (updated_at) COMMENT '按更新时间查询索引',
    
    -- 外键约束
    FOREIGN KEY (target_sha1) REFERENCES git_objects(sha1) ON DELETE RESTRICT
) COMMENT = 'Git引用存储表，存储分支、标签、HEAD等引用';

-- =============================================
-- 暂存区表
-- =============================================

-- 暂存区索引表 - 存储当前暂存的文件状态
CREATE TABLE staging_index (
    -- 记录ID
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '记录自增ID',
    
    -- 文件路径（工作区相对路径）
    file_path VARCHAR(1024) NOT NULL COMMENT '文件在工作区的相对路径',
    
    -- 对应的blob对象SHA1
    blob_sha1 CHAR(40) NOT NULL COMMENT '文件内容对应的blob对象SHA1',
    
    -- 文件模式（权限）
    file_mode VARCHAR(6) NOT NULL DEFAULT '100644' COMMENT '文件模式，如100644(普通文件), 100755(可执行文件), 040000(目录)',
    
    -- 文件状态
    stage_status ENUM('added', 'modified', 'deleted', 'conflict') DEFAULT 'added' COMMENT '文件在暂存区的状态',
    
    -- 文件大小
    file_size INT UNSIGNED COMMENT '文件大小（字节）',
    
    -- 暂存时间
    staged_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '文件暂存时间',
    
    -- 索引
    UNIQUE INDEX idx_file_path (file_path) COMMENT '文件路径唯一索引',
    INDEX idx_blob_sha1 (blob_sha1) COMMENT '按blob SHA1查询索引',
    INDEX idx_staged_at (staged_at) COMMENT '按暂存时间查询索引',
    INDEX idx_stage_status (stage_status) COMMENT '按暂存状态查询索引',
    
    -- 外键约束
    FOREIGN KEY (blob_sha1) REFERENCES git_objects(sha1) ON DELETE RESTRICT
) COMMENT = 'Git暂存区索引表，存储已暂存的文件信息';

-- =============================================
-- 提交历史优化表
-- =============================================

-- 提交信息扩展表 - 优化提交历史查询
CREATE TABLE commit_info (
    -- 提交SHA1
    commit_sha1 CHAR(40) PRIMARY KEY COMMENT '提交对象的SHA1',
    
    -- 树对象SHA1
    tree_sha1 CHAR(40) NOT NULL COMMENT '提交对应的树对象SHA1',
    
    -- 父提交列表（JSON格式存储多个父提交）
    parent_commits JSON COMMENT '父提交SHA1列表，JSON数组格式',
    
    -- 作者信息
    author_name VARCHAR(255) NOT NULL COMMENT '作者姓名',
    author_email VARCHAR(255) NOT NULL COMMENT '作者邮箱',
    author_timestamp TIMESTAMP NOT NULL COMMENT '作者时间戳',
    
    -- 提交者信息
    committer_name VARCHAR(255) NOT NULL COMMENT '提交者姓名',
    committer_email VARCHAR(255) NOT NULL COMMENT '提交者邮箱', 
    committer_timestamp TIMESTAMP NOT NULL COMMENT '提交者时间戳',
    
    -- 提交消息
    commit_message TEXT NOT NULL COMMENT '提交消息',
    
    -- 提交消息摘要（第一行）
    message_summary VARCHAR(512) COMMENT '提交消息的第一行（摘要）',
    
    -- 索引
    INDEX idx_tree_sha1 (tree_sha1) COMMENT '按树对象查询索引',
    INDEX idx_author_timestamp (author_timestamp) COMMENT '按作者时间查询索引',
    INDEX idx_committer_timestamp (committer_timestamp) COMMENT '按提交者时间查询索引',
    INDEX idx_author_email (author_email) COMMENT '按作者邮箱查询索引',
    INDEX idx_message_summary (message_summary(255)) COMMENT '按消息摘要查询索引',
    
    -- 外键约束
    FOREIGN KEY (commit_sha1) REFERENCES git_objects(sha1) ON DELETE CASCADE,
    FOREIGN KEY (tree_sha1) REFERENCES git_objects(sha1) ON DELETE RESTRICT
) COMMENT = '提交信息扩展表，优化提交历史查询性能';

-- =============================================
-- 树结构解析表
-- =============================================

-- 树条目表 - 解析tree对象的内容，便于快速查询目录结构
CREATE TABLE tree_entries (
    -- 记录ID
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '记录自增ID',
    
    -- 所属tree对象的SHA1
    tree_sha1 CHAR(40) NOT NULL COMMENT '所属树对象的SHA1',
    
    -- 条目在tree中的顺序
    entry_order INT NOT NULL COMMENT '条目在树中的顺序位置',
    
    -- 文件模式
    entry_mode VARCHAR(6) NOT NULL COMMENT '条目模式，如100644, 100755, 040000',
    
    -- 对象类型
    entry_type ENUM('blob', 'tree') NOT NULL COMMENT '条目指向的对象类型',
    
    -- 目标对象SHA1
    target_sha1 CHAR(40) NOT NULL COMMENT '条目指向的目标对象SHA1',
    
    -- 条目名称（文件名或目录名）
    entry_name VARCHAR(512) NOT NULL COMMENT '条目名称（文件或目录名）',
    
    -- 完整路径（从仓库根目录开始）
    full_path VARCHAR(1024) COMMENT '条目的完整路径',
    
    -- 索引
    INDEX idx_tree_sha1 (tree_sha1) COMMENT '按树对象查询索引',
    INDEX idx_target_sha1 (target_sha1) COMMENT '按目标对象查询索引',
    INDEX idx_entry_name (entry_name) COMMENT '按条目名称查询索引',
    INDEX idx_full_path (full_path(255)) COMMENT '按完整路径查询索引',
    UNIQUE INDEX idx_tree_entry (tree_sha1, entry_name) COMMENT '树内条目唯一索引',
    
    -- 外键约束
    FOREIGN KEY (tree_sha1) REFERENCES git_objects(sha1) ON DELETE CASCADE,
    FOREIGN KEY (target_sha1) REFERENCES git_objects(sha1) ON DELETE RESTRICT
) COMMENT = '树条目解析表，存储树对象的目录结构信息';

-- =============================================
-- 配置表
-- =============================================

-- 仓库配置表 - 存储Git配置信息
CREATE TABLE repository_config (
    -- 配置键
    config_key VARCHAR(255) NOT NULL COMMENT '配置键',
    
    -- 配置值
    config_value TEXT COMMENT '配置值',
    
    -- 配置作用域
    config_scope ENUM('local', 'global', 'system') DEFAULT 'local' COMMENT '配置作用域',
    
    -- 配置分区
    config_section VARCHAR(100) COMMENT '配置分区，如core, user, branch等',
    
    -- 最后修改时间
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '配置最后修改时间',
    
    -- 主键
    PRIMARY KEY (config_key, config_scope),
    
    -- 索引
    INDEX idx_config_section (config_section) COMMENT '按配置分区查询索引',
    INDEX idx_config_scope (config_scope) COMMENT '按配置作用域查询索引'
) COMMENT = '仓库配置表，存储Git配置信息';

-- =============================================
-- 远程仓库表
-- =============================================

-- 远程仓库配置表
CREATE TABLE remotes (
    -- 远程仓库名称
    remote_name VARCHAR(100) PRIMARY KEY COMMENT '远程仓库名称，如origin',
    
    -- 远程仓库URL
    remote_url VARCHAR(1024) NOT NULL COMMENT '远程仓库URL',
    
    -- 推送URL（如果与拉取URL不同）
    push_url VARCHAR(1024) COMMENT '推送URL',
    
    -- 获取引用规格
    fetch_spec VARCHAR(1024) DEFAULT '+refs/heads/*:refs/remotes/origin/*' COMMENT '获取引用规格',
    
    -- 创建时间
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '远程仓库添加时间',
    
    -- 索引
    INDEX idx_remote_url (remote_url(255)) COMMENT '按远程URL查询索引'
) COMMENT = '远程仓库配置表';

-- =============================================
-- 分支跟踪信息表
-- =============================================

-- 分支跟踪信息表
CREATE TABLE branch_tracking (
    -- 本地分支名称
    branch_name VARCHAR(255) PRIMARY KEY COMMENT '本地分支名称',
    
    -- 跟踪的远程分支
    remote_branch VARCHAR(512) NOT NULL COMMENT '跟踪的远程分支，如refs/remotes/origin/main',
    
    -- 远程仓库名称
    remote_name VARCHAR(100) NOT NULL COMMENT '远程仓库名称',
    
    -- 最后获取时间
    last_fetched TIMESTAMP NULL COMMENT '最后从远程获取时间',
    
    -- 索引
    INDEX idx_remote_name (remote_name) COMMENT '按远程仓库名称查询索引',
    INDEX idx_remote_branch (remote_branch) COMMENT '按远程分支查询索引',
    
    -- 外键约束
    FOREIGN KEY (remote_name) REFERENCES remotes(remote_name) ON DELETE CASCADE
) COMMENT = '分支跟踪信息表，存储本地分支与远程分支的跟踪关系';


## 表关系

| 表名                | 主要作用             | 核心字段                               |
| :------------------ | :------------------- | :------------------------------------- |
| `git_objects`       | 存储所有Git对象      | sha1, object_type, object_data         |
| `references`        | 存储分支、标签等引用 | ref_name, target_sha1, ref_type        |
| `staging_index`     | 存储暂存区文件状态   | file_path, blob_sha1, file_mode        |
| `commit_info`       | 优化提交历史查询     | commit_sha1, tree_sha1, parent_commits |
| `tree_entries`      | 解析目录结构         | tree_sha1, entry_name, target_sha1     |
| `repository_config` | 存储配置信息         | config_key, config_value, config_scope |
| `remotes`           | 远程仓库配置         | remote_name, remote_url                |
| `branch_tracking`   | 分支跟踪信息         | branch_name, remote_branch             |